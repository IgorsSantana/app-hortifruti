<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Contagem</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @page { size: tabloid; margin: 0cm; }
        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .navbar, .botoes-acao, .header-card { display: none !important; }
            .container-fluid { margin-top: 0 !important; max-width: 100%; padding: 0; }
            .card { box-shadow: none !important; border: none !important; }
            input { border: none !important; background-color: transparent !important; text-align: center !important;}
            h1, h2, hr { display: none; }
            .card-body { padding: 0 !important; }
        }
        #relatorio-tabela th, #relatorio-tabela td {
            text-align: center;
            vertical-align: middle;
            font-size: 0.9rem;
            padding: 0.5rem;
        }
        #relatorio-tabela thead th {
            font-size: 0.8rem;
        }
        #relatorio-tabela tbody th {
            text-align: left;
            font-size: 0.85rem;
        }
        .pedido-input {
            max-width: 70px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/relatorio">Relatório</a>
            <div class="navbar-nav me-auto"><a class="nav-link" href="/admin">Dashboard Admin</a></div>
            <div class="d-flex">
                <span class="navbar-text me-3">Logado como: <strong>{{ session.username }} (Admin)</strong></span>
                <a href="/logout" class="btn btn-outline-light">Sair</a>
            </div>
        </div>
    </nav>
    <div class="container-fluid mt-4 mb-5">
        <div class="card shadow-sm mb-4 header-card">
            <div class="card-body d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">Contagem Hortifruti</h1>
                <form class="d-flex align-items-center" method="GET" action="/relatorio">
                    <label for="data-relatorio" class="form-label me-2 mb-0"><strong>Selecionar Data:</strong></label>
                    <input type="date" id="data-relatorio" name="data" class="form-control" style="width: auto;" value="{{ data_selecionada }}">
                    <button type="submit" class="btn btn-primary ms-2">Ver Relatório</button>
                </form>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h2 class="h4 mb-0">Exibindo Relatório para: <strong>{{ data_hoje }}</strong></h2>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="relatorio-tabela">
                        <thead class="table-dark">
                            <tr>
                                <th rowspan="2" style="width: 20%;">Produto</th>
                                <th rowspan="2" style="width: 5%;">Custo</th>
                                {% for loja_nome in lojas %}
                                    <th colspan="3">{{ loja_nome }}</th>
                                {% endfor %}
                            </tr>
                            <tr>
                                {% for loja_nome in lojas %}
                                    <th>Caixa</th>
                                    <th>Un/Kg</th>
                                    <th>Pedido</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for produto in report_data %}
                            <tr>
                                <th scope="row" class="text-start">{{ produto.produto_nome }}</th>
                                <td>{{ produto.custo }}</td>
                                {% for loja in produto.lojas %}
                                    <td>{{ loja.caixa if loja.caixa > 0 else '-' }}</td>
                                    <td>{{ loja.fracao if loja.fracao != '0' else '-' }}</td>
                                    <td>
                                        <input type="number" data-produto="{{ produto.produto_nome }}" data-loja="{{ loja.nome }}" 
                                               class="form-control form-control-sm pedido-input mx-auto" min="0"
                                               value="{{ loja.pedido_salvo }}">
                                    </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="mt-4 d-flex justify-content-end botoes-acao">
            <button id="btn-salvar-pedido" class="btn btn-primary">Salvar Pedido</button>
            <button onclick="window.print()" class="btn btn-secondary ms-2">Imprimir Relatório de Contagem</button>
            <button id="btn-gerar-pedido" class="btn btn-danger ms-2">Gerar PDF do Pedido</button>
            <form id="pedido-form" action="/exportar-pedido-pdf" method="POST" style="display: none;">
                <input type="hidden" name="pedido_data" id="pedido_data_input">
                <input type="hidden" name="data_pedido_pdf" value="{{ data_selecionada }}">
            </form>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('btn-salvar-pedido').addEventListener('click', function() {
            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Salvando...';
            btn.disabled = true;

            const inputs = document.querySelectorAll('.pedido-input');
            const pedido_data = [];
            inputs.forEach(input => {
                if (input.value && parseInt(input.value) >= 0) { 
                    pedido_data.push({
                        produto: input.getAttribute('data-produto'),
                        loja: input.getAttribute('data-loja'),
                        pedido: input.value
                    });
                }
            });

            fetch('/salvar-pedido', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'pedido_data': JSON.stringify(pedido_data)
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.status === 'success') {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');
                    btn.innerHTML = 'Salvo!';
                } else {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-danger');
                    btn.innerHTML = 'Erro!';
                    alert('Erro ao salvar o pedido: ' + data.message);
                }
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    btn.classList.remove('btn-success', 'btn-danger');
                    btn.classList.add('btn-primary');
                }, 2000);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro de comunicação ao salvar o pedido.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        });

        document.getElementById('btn-gerar-pedido').addEventListener('click', function() {
            const inputs = document.querySelectorAll('.pedido-input');
            const pedido_data = [];

            inputs.forEach(input => {
                if (input.value && parseInt(input.value) > 0) {
                    pedido_data.push({
                        produto: input.getAttribute('data-produto'),
                        loja: input.getAttribute('data-loja'),
                        pedido: input.value
                    });
                }
            });

            if (pedido_data.length === 0) {
                alert('Nenhum item de pedido foi preenchido.');
                return;
            }

            document.getElementById('pedido_data_input').value = JSON.stringify(pedido_data);
            document.getElementById('pedido-form').submit();
        });
    </script>
</body>
</html>